# Schemat Bazy Danych PostgreSQL dla 10xCards

## 1. Lista Tabel

### Tabela: `generations`

Tabela przechowuje metryki związane z procesem generowania fiszek przez AI. Każdy wiersz reprezentuje jedną sesję generowania.

| Nazwa Kolumny   | Typ Danych     | Ograniczenia                                                                    | Opis                                                                 |
| --------------- | -------------- | ------------------------------------------------------------------------------- | -------------------------------------------------------------------- |
| `id`            | `bigint`       | `PRIMARY KEY`, `GENERATED BY DEFAULT AS IDENTITY`                                 | Unikalny identyfikator rekordu generowania.                          |
| `user_id`       | `uuid`         | `NOT NULL`, `REFERENCES auth.users(id) ON DELETE CASCADE`                         | Klucz obcy wskazujący na użytkownika, który zlecił generowanie.      |
| `generated_count` | `integer`      | `NOT NULL`                                                                      | Liczba fiszek zaproponowanych przez AI w danej sesji.                |
| `accepted_count`| `integer`      | `NULLABLE`                                                                      | Liczba fiszek, które użytkownik zaakceptował i zapisał.              |
| `created_at`    | `timestamptz`  | `NOT NULL`, `DEFAULT now()`                                                     | Znacznik czasowy utworzenia rekordu.                                 |
| `updated_at`    | `timestamptz` | `NOT NULL`, `DEFAULT now()`                                                    | Znacznik czasowy ostatniej modyfikacji (wymaga triggera do auto-aktualizacji).          |

---

### Tabela: `flashcards`

Główna tabela aplikacji, przechowująca wszystkie fiszki użytkowników wraz z danymi niezbędnymi do algorytmu powtórek SM-2.

| Nazwa Kolumny     | Typ Danych    | Ograniczenia                                                                                               | Opis                                                                                    |
| ----------------- | ------------- | ---------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------- |
| `id`              | `uuid`        | `PRIMARY KEY`, `DEFAULT gen_random_uuid()`                                                                 | Unikalny identyfikator fiszki.                                                          |
| `user_id`         | `uuid`        | `NOT NULL`, `REFERENCES auth.users(id) ON DELETE CASCADE`                                                  | Klucz obcy wskazujący na właściciela fiszki.                                            |
| `front`           | `text`        | `NOT NULL`, `CHECK (char_length(front) > 0 AND char_length(front) <= 200)`                                  | Treść "przodu" fiszki (pytanie).                                                        |
| `back`            | `text`        | `NOT NULL`, `CHECK (char_length(back) > 0 AND char_length(back) <= 500)`                                    | Treść "tyłu" fiszki (odpowiedź).                                                        |
| `interval`        | `integer`     | `NOT NULL`, `DEFAULT 0`                                                                                    | (SM-2) Liczba dni do następnej powtórki.                                                 |
| `repetition`      | `integer`     | `NOT NULL`, `DEFAULT 0`                                                                                    | (SM-2) Liczba pomyślnych powtórek z rzędu.                                               |
| `ease_factor`     | `real`        | `NOT NULL`, `DEFAULT 2.5`                                                                                  | (SM-2) Współczynnik łatwości, wpływający na `interval`.                                  |
| `due_date`        | `timestamptz` | `NOT NULL`, `DEFAULT now()`                                                                                | Data następnej zaplanowanej powtórki.                                                   |
| `generation_type` | `varchar(10)` | `NOT NULL`, `CHECK (generation_type IN ('ai', 'manual'))`                                                  | Określa, czy fiszka została stworzona manualnie, czy przez AI.                          |
| `generation_id`   | `bigint`      | `NULL`, `REFERENCES generations(id) ON DELETE SET NULL`                                                    | Klucz obcy do tabeli `generations` (tylko dla fiszek AI).                               |
| `created_at`      | `timestamptz` | `NOT NULL`, `DEFAULT now()`                                                                                | Znacznik czasowy utworzenia fiszki.                                                     |
| `updated_at`      | `timestamptz` | `NOT NULL`, `DEFAULT now()`                                                                                | Znacznik czasowy ostatniej modyfikacji (wymaga triggera do auto-aktualizacji).          |

## 2. Relacje Między Tabelami

-   **`auth.users` (1) -> (N) `flashcards`**: Jeden użytkownik może posiadać wiele fiszek. Relacja zaimplementowana przez `flashcards.user_id`. Usunięcie użytkownika kaskadowo usuwa wszystkie jego fiszki.
-   **`auth.users` (1) -> (N) `generations`**: Jeden użytkownik może zainicjować wiele procesów generowania fiszek przez AI. Relacja zaimplementowana przez `generations.user_id`. Usunięcie użytkownika kaskadowo usuwa wszystkie jego wpisy w `generations`.
-   **`generations` (1) -> (N) `flashcards`**: Jeden proces generowania przez AI może skutkować utworzeniem wielu fiszek. Relacja zaimplementowana przez `flashcards.generation_id`. Jest to relacja opcjonalna, ponieważ fiszki tworzone manualnie nie mają powiązania z tabelą `generations`.

## 3. Indeksy

-   **Indeks złożony na `flashcards`**:
    -   `CREATE INDEX idx_flashcards_user_due_date ON public.flashcards (user_id, due_date);`
    -   Cel: Optymalizacja zapytań wyszukujących fiszki do nauki dla konkretnego użytkownika na dany dzień.
-   **Indeksy domyślne**: Klucze podstawowe (`id` w obu tabelach) oraz klucze obce (`user_id`, `generation_id`) są automatycznie indeksowane przez PostgreSQL w celu zapewnienia wydajności operacji `JOIN`.

## 4. Zasady PostgreSQL (Row-Level Security)

### Tabela `flashcards`

RLS zostanie włączone dla tabeli `flashcards`, aby zapewnić, że użytkownicy mogą wykonywać operacje (CRUD) wyłącznie na swoich własnych danych.

```sql
-- 1. Włączenie RLS dla tabeli
ALTER TABLE public.flashcards ENABLE ROW LEVEL SECURITY;

-- 2. Stworzenie polityki dostępu dla właścicieli fiszek
CREATE POLICY "Użytkownicy mogą zarządzać tylko swoimi fiszkami"
ON public.flashcards
FOR ALL
USING (auth.uid() = user_id);
```

### Tabela `generations`

RLS zostanie włączone dla tabeli `generations`, aby zapewnić, że użytkownicy mogą wykonywać operacje (CRUD) wyłącznie na swoich własnych danych.

```sql
-- 1. Włączenie RLS dla tabeli
ALTER TABLE public.generations ENABLE ROW LEVEL SECURITY;

-- 2. Stworzenie polityki dostępu dla właścicieli generacji
CREATE POLICY "Użytkownicy mogą zarządzać tylko swoimi generacjami"
ON public.generations
FOR ALL
USING (auth.uid() = user_id);
```

## 5. Dodatkowe Uwagi i Wyjaśnienia

-   **Tabela `auth.users`**: Schemat opiera się na standardowej tabeli `auth.users` dostarczanej przez Supabase. Nie ma potrzeby tworzenia dodatkowej, publicznej tabeli `profiles`.
-   **Trigger `updated_at`**: Aby kolumna `updated_at` w tabeli `flashcards` była automatycznie aktualizowana przy każdej zmianie, należy stworzyć dedykowaną funkcję i trigger w PostgreSQL.
    ```sql
    -- Funkcja aktualizująca timestamp
    CREATE OR REPLACE FUNCTION public.handle_updated_at()
    RETURNS TRIGGER AS $$
    BEGIN
      NEW.updated_at = now();
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    -- Trigger dla tabeli flashcards
    CREATE TRIGGER on_flashcards_updated
    BEFORE UPDATE ON public.flashcards
    FOR EACH ROW
    EXECUTE PROCEDURE public.handle_updated_at();
    ```
-   **Trigger `updated_at`**: Aby kolumna `updated_at` w tabeli `generations` była automatycznie aktualizowana przy każdej zmianie, należy stworzyć dedykowaną funkcję i trigger w PostgreSQL.
    ```sql
    -- Funkcja aktualizująca timestamp
    CREATE OR REPLACE FUNCTION public.handle_updated_at()
    RETURNS TRIGGER AS $$
    BEGIN
      NEW.updated_at = now();
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    -- Trigger dla tabeli generations
    CREATE TRIGGER on_generations_updated
    BEFORE UPDATE ON public.generations
    FOR EACH ROW
    EXECUTE PROCEDURE public.handle_updated_at();
    ```
-   **Zarządzanie Propozycjami AI**: Logika biznesowa dotycząca edycji, selekcji i akceptacji fiszek wygenerowanych przez AI jest zarządzana po stronie klienta (frontendu). Do bazy danych trafiają wyłącznie fiszki jawnie zaakceptowane przez użytkownika.
